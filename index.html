<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>テキストベースでコロックルをプログラム -コロボックル-</title>
<style>
textarea { width: 80%; height: 700px; }
</style>
</head>
<body>

    <h2>コロボックル</h2>
    <textarea id="input" rows="20" cols="60"></textarea>

    <button id="saveBlp" tabindex="-1">ブロック形式blpで保存</button>
    <button id="saveFcp" tabindex="-1">フローチャート形式fcpで保存</button>

<script>
const editor = document.getElementById("input");

editor.addEventListener("keydown", function(e) {
    if (e.key === "Tab") {
        e.stopPropagation();  // 他の処理へ渡さない（重要）
        e.preventDefault();

        const indent = "    ";
        const start = editor.selectionStart;
        const end = editor.selectionEnd;

        editor.setRangeText(indent, start, end, "end");
    }
});


document.getElementById("saveBlp").addEventListener("click", () => {
    saveFile("blp");
});

document.getElementById("saveFcp").addEventListener("click", () => {
    saveFile("fcp");
});


function saveFile(ext) {
    const textarea = document.getElementById("input");
    const text = textarea.value;

    const lines = text.split("\n");
    let code = [];

    code.push("<BlockStart>")
    code.push("  <LineCount>1</LineCount>")
    code.push("  <ConnectIndex>2</ConnectIndex>")
    code.push("  <ConnectIndexBefore>-1</ConnectIndexBefore>")
    code.push("</BlockStart>")
    code.push("<BlockEnd>")
    code.push("  <LineCount>1</LineCount>")
    code.push("  <ConnectIndex>-1</ConnectIndex>")
    code.push("  <ConnectIndexBefore>"+(lines.length+1)+"</ConnectIndexBefore>")
    code.push("</BlockEnd>")
    
    const indexes = []

    for (let i = 0; i < lines.length; i++) {
        const woords = lines[i].split(/[, ]/).filter(s => s);


        const myindex = (lines[i].match(/^\s*/)[0].length)/4
        let beforeindex = null;
        if (indexes.length > 0) {
            beforeindex = Number(indexes[indexes.length-1].split(",")[1])
            if (beforeindex == myindex) {
                if (woords[0] == "else"){
                    code.splice(Number(indexes[indexes.length-1].split(",")[0]), 0, "  <ConnectIndexElse>"+(i+3)+"</ConnectIndexElse>")
                }else{
                    code.splice(Number(indexes[indexes.length-1].split(",")[0]), 0, "  <ConnectIndex>"+(i+2)+"</ConnectIndex>")
                
                }
            }

        }


        
        if (woords[0] == "led") {
            code.push("<BlockLED>");
            code.push("  <LineCount>1</LineCount>")
            if (i == lines.length-1){
                code.push("  <ConnectIndex>1</ConnectIndex>")
            }else{
                code.push("  <ConnectIndex>"+(i+3)+"</ConnectIndex>")
            }
            if (i == 0){
                code.push("  <ConnectIndexBefore>"+(i)+"</ConnectIndexBefore>")
            }else{
                code.push("  <ConnectIndexBefore>"+(i+1)+"</ConnectIndexBefore>")
            }
            
            if (woords[1] == "on") {
                code.push("  <Mode>ON</Mode>");
                code.push("  <Red>"+(woords[2])+"</Red>");
                code.push("  <Green>"+(woords[3])+"</Green>");
                code.push("  <Blue>"+(woords[4])+"</Blue>");
            }else if (woords[1] == "time"){
                code.push("  <Mode>ON_TIME</Mode>");
                code.push("  <Red>"+(woords[2])+"</Red>");
                code.push("  <Green>"+(woords[3])+"</Green>");
                code.push("  <Blue>"+(woords[4])+"</Blue>");
                code.push("  <Time>"+(woords[5])+"</Time>");
            }else if (woords[1] == "off"){
                code.push("  <Mode>OFF</Mode>");
            }else if (woords[1] == "in"){
                code.push("  <Mode>ON_TIME</Mode>");
                code.push("  <Red>"+(woords[2])+"</Red>");
                code.push("  <Green>"+(woords[3])+"</Green>");
                code.push("  <Blue>"+(woords[4])+"</Blue>");
                code.push("  <Time>"+(woords[5])+"</Time>");
                code.push("  <Fade>IN</Fade>");
            }else if (woords[1] == "out"){
                code.push("  <Mode>ON_TIME</Mode>");
                code.push("  <Red>"+(woords[2])+"</Red>");
                code.push("  <Green>"+(woords[3])+"</Green>");
                code.push("  <Blue>"+(woords[4])+"</Blue>");
                code.push("  <Time>"+(woords[5])+"</Time>");
                code.push("  <Fade>OUT</Fade>");
            }
            code.push("</BlockLED>");

        } else if (woords[0] == "beep") {
            code.push("<BlockSound>");
            code.push("  <LineCount>1</LineCount>")
            if (i == lines.length-1){
                code.push("  <ConnectIndex>1</ConnectIndex>")
            }else{
                code.push("  <ConnectIndex>"+(i+3)+"</ConnectIndex>")
            }
            if (i == 0){
                code.push("  <ConnectIndexBefore>"+(i)+"</ConnectIndexBefore>")
            }else{
                code.push("  <ConnectIndexBefore>"+(i+1)+"</ConnectIndexBefore>")
            }
            if (woords[1] == "play") {
                if (woords[1] == "true") {
                    code.push("  <Loop>true</Loop>");
                }else {
                    code.push("  <Loop>false</Loop>");
                }
                code.push("  <Mode>MELODY_PLAY</Mode>");
            }else if (woords[1] == "stop") {
                code.push("  <Mode>MELODY_STOP</Mode>");
            }else {
                code.push("  <Mode>BEEP</Mode>");
                code.push("  <BeepIndex>"+(woords[1]-1)+"</BeepIndex>");
            }
            code.push("</BlockSound>");

        } else if (woords[0] == "wait") {
            code.push("<BlockWait>")
            code.push("  <LineCount>1</LineCount>")
            if (i == lines.length-1){
                code.push("  <ConnectIndex>1</ConnectIndex>")
            }else{
                code.push("  <ConnectIndex>"+(i+3)+"</ConnectIndex>")
            }
            if (i == 0){
                code.push("  <ConnectIndexBefore>"+(i)+"</ConnectIndexBefore>")
            }else{
                code.push("  <ConnectIndexBefore>"+(i+1)+"</ConnectIndexBefore>")
            }
            code.push("  <Time>"+(woords[1])+"</Time>")
            code.push("</BlockWait>");

        } else if (woords[0] == "count") {
            code.push("<BlockCounter>")
            code.push("  <LineCount>1</LineCount>")
            if (i == 0){
                code.push("  <ConnectIndexBefore>"+(i)+"</ConnectIndexBefore>")
            }else{
                code.push("  <ConnectIndexBefore>"+(i+1)+"</ConnectIndexBefore>")
            }
            if (woords[1] == "start") {
                code.push("  <Command>START</Command>")
            }else if (woords[1] == "stop") {
                code.push("  <Command>STOP</Command>")
            }else if (woords[1] == "reset") {
                code.push("  <Command>RESET</Command>")
            }
            code.push("</BlockCounter>");
        }else if (woords[0] == "if") {
            code.push("<BlockIf>")
            code.push("  <LineCount>1</LineCount>")
            indexes.push(String(code.length)+","+String(myindex))
            if (i == 0){
                code.push("  <ConnectIndexBefore>"+(i)+"</ConnectIndexBefore>")
            }else{
                code.push("  <ConnectIndexBefore>"+(i+1)+"</ConnectIndexBefore>")
            }
            if (woords[1] == "botton") {
                code.push("  <ConnectIndexBranches>")
                if (i == lines.length-1){
                    code.push("    <int>1</int>")
                }else{
                    code.push("    <int>"+(i+3)+"</int>")
                }
                code.push("  </ConnectIndexBranches>")
                code.push("  <Condition>BUTTON</Condition>")
                code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                code.push("  <Select>BUTTON_ON</Select>")


            }
            code.push("</BlockIf>")
                
        }
        
        

        
    }

    downloadFile(code.join("\n"), `output.${ext}`);
}


// ダウンロード関数
function downloadFile(text, filename) {
    const blob = new Blob([text], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
}

</script>
</body>
</html>
