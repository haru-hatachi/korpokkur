<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>テキストベースでコロックルをプログラム -コロボックル-</title>
<meta name="description" content="コロックルのプログラムをテキスト形式で保存する「.blp」「.fcp」をテキスト形式のプログラミングで生成することができます。">
<meta name="msvalidate.01" content="6CC00A4A5A2E19F7FFE2EA1E6F3B3A9B" />
<style>
textarea { width: 80%; height: 700px; }
.tabs {
  display: flex;
  margin-bottom: 10px;
}

.tab-button {
  padding: 8px 12px;
  border: 1px solid #aaa;
  border-bottom: none;
  cursor: pointer;
  background: #eee;
}

.tab-button.active {
  background: white;
  font-weight: bold;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

textarea {
  width: 100%;
  height: 600px;
}

</style>
</head>
<body>

    <h1>コロボックル</h1>

<div class="tabs">
  <button class="tab-button active" data-tab="main">メイン</button>
  <button class="tab-button" data-tab="sub1">サブ1</button>
  <button class="tab-button" data-tab="sub2">サブ2</button>
  <button class="tab-button" data-tab="sub3">サブ3</button>
  <button class="tab-button" data-tab="sub4">サブ4</button>
</div>

<div class="tab-content active" id="main">
  <textarea id="input-main"></textarea>
</div>

<div class="tab-content" id="sub1">
  <textarea id="input-sub1"></textarea>
</div>

<div class="tab-content" id="sub2">
  <textarea id="input-sub2"></textarea>
</div>

<div class="tab-content" id="sub3">
  <textarea id="input-sub3"></textarea>
</div>

<div class="tab-content" id="sub4">
  <textarea id="input-sub4"></textarea>
</div>





    <button id="saveBlp" tabindex="-1">ブロック形式blpで保存</button>
    <button id="saveFcp" tabindex="-1">フローチャート形式fcpで保存</button>

<script>
const tabButtons = document.querySelectorAll('.tab-button');
const tabContents = document.querySelectorAll('.tab-content');

tabButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tab;

    // ボタンを更新
    tabButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // コンテンツを更新
    tabContents.forEach(c => c.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
  });
});


const editor = document.getElementById("input-main");

editor.addEventListener("keydown", function(e) {
    if (e.key === "Tab") {
        e.stopPropagation();  // 他の処理へ渡さない
        e.preventDefault();

        const indent = "    ";
        const start = editor.selectionStart;
        const end = editor.selectionEnd;

        editor.setRangeText(indent, start, end, "end");
    }
});


document.getElementById("saveBlp").addEventListener("click", () => {
    saveFile("blp");
});

document.getElementById("saveFcp").addEventListener("click", () => {
    saveFile("fcp");
});

function connectindex(i,l,iflast){
    if (iflast==0) {
        if (i == l-2){
            return ("  <ConnectIndex>1</ConnectIndex>")
        }else{
            return ("  <ConnectIndex>"+(i+3)+"</ConnectIndex>")
        }
        }else {
            return ("  <ConnectIndex>-1</ConnectIndex>")
        }
}
function variable_number(name){
    if (name == "a") {
        return ("0")
    }else if (name == "b") {
        return ("1")
    }else if (name == "c") {
        return ("2")
    }else if (name == "d") {
        return ("3")
    }else if (name == "e") {
        return ("4")
    }else if (name == "f") {
        return ("5")
    }else if (name == "g") {
        return ("6")
    }else if (name == "h") {
        return ("7")
    }
}
function before(lines,i,myindex) {
    let ind = 0
    for (let j = i - 1; j >= 0; j--) {
        
        if (lines[j] == "else") {
            ind = lines[j].match(/^\s*/)[0].length / 4 + 1;
        }else {
            ind = lines[j].match(/^\s*/)[0].length / 4;
        }
        if (ind === myindex) {
            targetInd = j;
            break;
        }
        
    }
    return(targetInd)

}
function connectindexbefore(i,iffast,lines,myindex) {
    if (iffast==0) {
        if (i == 0){
            return("  <ConnectIndexBefore>"+(i)+"</ConnectIndexBefore>")
        }else{
            
            return("  <ConnectIndexBefore>"+(before(lines,i,myindex)+2)+"</ConnectIndexBefore>")
        }    
    }else {
        return("  <ConnectIndexBefore>-1</ConnectIndexBefore>")
    }
}


function saveFile(ext) {
    const textarea = document.getElementById("input-main");
    const text = textarea.value;

    const lines = text.split("\n");
    for (let i = lines.length - 1; i >= 0; i--) {
        if (lines[i].trim() === "") {
            lines.splice(i, 1);
        }
    }
    lines.push("")
    let code = [];

    code.push("<BlockStart>")
    code.push("  <LineCount>1</LineCount>")
    code.push("  <ConnectIndex>2</ConnectIndex>")
    code.push("  <ConnectIndexBefore>-1</ConnectIndexBefore>")
    code.push("</BlockStart>")
    code.push("<BlockEnd>")
    code.push("  <LineCount>1</LineCount>")
    code.push("  <ConnectIndex>-1</ConnectIndex>")
    code.push("</BlockEnd>")
    
    let indexes = []
    let l = lines.length
    for (let i = 0; i < l; i++) {
        const woords = lines[i].split(/[, ]/).filter(s => s);
        const myindex = 0
        if (lines[i].trim() === "") {
            i=i-1
            l=l-1
            code.splice(8, 0, "  <ConnectIndexBefore>"+(before(lines,lines.length-1,myindex)+2)+"</ConnectIndexBefore>")
            while (indexes.length > 0) {
                if (indexes.length == 1) {
                    code.splice(Number(indexes[indexes.length-1].split(",")[0]), 0, "  <ConnectIndex>1</ConnectIndex>")
                }else {
                    code.splice(Number(indexes[indexes.length-1].split(",")[0]), 0, "  <ConnectIndex>-1</ConnectIndex>")
                }
                indexes.splice(indexes.length-1, 1)
            }
        }else{

            let iffast = 0;
            let iflast = 0;


            const myindex = (lines[i].match(/^\s*/)[0].length)/4
            let beforeindex = null;
            if (indexes.length > 0) {
                beforeindex = Number(indexes[indexes.length-1].split(",")[1])
                if (beforeindex >= myindex) {
                    while (beforeindex != myindex) {
                        if (woords[0] == "else") {
                            code.splice(Number(indexes[indexes.length-1].split(",")[0]), 0, "  <ConnectIndex>-1</ConnectIndex>")
                            indexes.splice(indexes.length-1, 1)
                            beforeindex = Number(indexes[indexes.length-1].split(",")[1])
                        }else {
                            code.splice(Number(indexes[indexes.length-1].split(",")[0]), 0, "  <ConnectIndex>"+(i+2)+"</ConnectIndex>")
                            indexes.splice(indexes.length-1, 1)
                            beforeindex = Number(indexes[indexes.length-1].split(",")[1])
                        }
                    }
                    if (woords[0] == "else"){
                        code.splice(Number(indexes[indexes.length-1].split(",")[0]) + 3, 0, "    <int>"+(i+2)+"</int>")
                    }else{
                        code.splice(Number(indexes[indexes.length-1].split(",")[0]), 0, "  <ConnectIndex>"+(i+2)+"</ConnectIndex>")
                        indexes.splice(indexes.length-1, 1)
                    }
                }else {
                    if ((lines[i-1].match(/^\s*/)[0].length)/4 < myindex) {
                        iffast = 1
                    }
                    if ((lines[i+1].match(/^\s*/)[0].length)/4 < myindex) {
                        iflast = 1
                    }
                    
                }
                

            }


            
            if (woords[0] == "led") {
                code.push("<BlockLED>");
                code.push("  <LineCount>1</LineCount>")
                code.push(connectindex(i,l,iflast));
                code.push(connectindexbefore(i,iffast,lines,myindex))
                
                if (woords[1] == "on") {
                    code.push("  <Mode>ON</Mode>");
                    code.push("  <Red>"+(woords[2])+"</Red>");
                    code.push("  <Green>"+(woords[3])+"</Green>");
                    code.push("  <Blue>"+(woords[4])+"</Blue>");
                }else if (woords[1] == "time"){
                    code.push("  <Mode>ON_TIME</Mode>");
                    code.push("  <Red>"+(woords[2])+"</Red>");
                    code.push("  <Green>"+(woords[3])+"</Green>");
                    code.push("  <Blue>"+(woords[4])+"</Blue>");
                    code.push("  <Time>"+(woords[5])+"</Time>");
                }else if (woords[1] == "off"){
                    code.push("  <Mode>OFF</Mode>");
                }else if (woords[1] == "in"){
                    code.push("  <Mode>ON_TIME</Mode>");
                    code.push("  <Red>"+(woords[2])+"</Red>");
                    code.push("  <Green>"+(woords[3])+"</Green>");
                    code.push("  <Blue>"+(woords[4])+"</Blue>");
                    code.push("  <Time>"+(woords[5])+"</Time>");
                    code.push("  <Fade>IN</Fade>");
                }else if (woords[1] == "out"){
                    code.push("  <Mode>ON_TIME</Mode>");
                    code.push("  <Red>"+(woords[2])+"</Red>");
                    code.push("  <Green>"+(woords[3])+"</Green>");
                    code.push("  <Blue>"+(woords[4])+"</Blue>");
                    code.push("  <Time>"+(woords[5])+"</Time>");
                    code.push("  <Fade>OUT</Fade>");
                }
                code.push("</BlockLED>");

            } else if (woords[0] == "beep") {
                code.push("<BlockSound>");
                code.push("  <LineCount>1</LineCount>")
                code.push(connectindex(i,l,iflast));
                code.push(connectindexbefore(i,iffast,lines,myindex))
                if (woords[1] == "play") {
                    if (woords[1] == "true") {
                        code.push("  <Loop>true</Loop>");
                    }else {
                        code.push("  <Loop>false</Loop>");
                    }
                    code.push("  <Mode>MELODY_PLAY</Mode>");
                }else if (woords[1] == "stop") {
                    code.push("  <Mode>MELODY_STOP</Mode>");
                }else {
                    code.push("  <Mode>BEEP</Mode>");
                    code.push("  <BeepIndex>"+(woords[1]-1)+"</BeepIndex>");
                }
                code.push("</BlockSound>");

            } else if (woords[0] == "wait") {
                code.push("<BlockWait>")
                code.push("  <LineCount>1</LineCount>")
                code.push(connectindex(i,l,iflast));
                code.push(connectindexbefore(i,iffast,lines,myindex))
                code.push("  <Time>"+(woords[1])+"</Time>")
                code.push("</BlockWait>");

            } else if (woords[0] == "count") {
                code.push("<BlockCounter>")
                code.push("  <LineCount>1</LineCount>")
                code.push(connectindex(i,l,iflast));
                code.push(connectindexbefore(i,iffast,lines,myindex))
                if (woords[1] == "start") {
                    code.push("  <Command>START</Command>")
                }else if (woords[1] == "stop") {
                    code.push("  <Command>STOP</Command>")
                }else if (woords[1] == "reset") {
                    code.push("  <Command>RESET</Command>")
                }
                code.push("</BlockCounter>");
            }else if (woords[0] == "if") {
                code.push("<BlockIf>")
                code.push("  <LineCount>1</LineCount>")
                indexes.push(String(code.length)+","+String(myindex)+","+String(i+2))
                code.push(connectindexbefore(i,iffast,lines,myindex))
                if (woords[1] == "button") {
                    code.push("  <ConnectIndexBranches>")
                    if (i == lines.length-1){
                        code.push("    <int>1</int>")
                    }else{
                        code.push("    <int>"+(i+3)+"</int>")
                    }
                    code.push("  </ConnectIndexBranches>")
                    code.push("  <Condition>BUTTON</Condition>")
                    code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                    if (woords[2] == "on") {
                        code.push("  <Select>BUTTON_ON</Select>")
                    }else {
                        code.push("  <Select>BUTTON_OFF</Select>")
                    }

                    code.push("  <Values>")
                    code.push("    <int>0</int>")
                    code.push("    <int>0</int>")
                    code.push("  </Values>")
                    code.push("  <VariableIndexes>")
                    code.push("    <int>0</int>")
                    code.push("    <int>0</int>")
                    code.push("  </VariableIndexes>")
                    code.push("  <Variable>INVALID</Variable>")


                }else if (woords[1] == "light") {
                        code.push("  <ConnectIndexBranches>")
                        if (i == lines.length-1){
                            code.push("    <int>1</int>")
                        }else{
                            code.push("    <int>"+(i+3)+"</int>")
                        }
                        code.push("  </ConnectIndexBranches>")
                        code.push("  <Condition>LIGHT</Condition>")
                        code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                        if (woords[2] == "==") {
                            code.push("  <Select>COMPARE_GREATER</Select>")
                        }else if (woords[2] == ">") {
                            code.push("  <Select>BUTTON_ON</Select>")
                        }else if (woords[2] == "<") {
                            code.push("  <Select>BUTTON_OFF</Select>")
                        }

                        code.push("  <Values>")
                        if (!isNaN(Number(woords[3]))) {
                            code.push("    <int>"+(woords[3])+"</int>")
                            code.push("    <int>0</int>")
                            code.push("  </Values>")
                            code.push("  <VariableIndexes>")
                            code.push("    <int>0</int>")
                            code.push("    <int>0</int>")
                            code.push("  </VariableIndexes>")
                            code.push("  <Variable>CONST</Variable>")
                        }else {
                            code.push("    <int>0</int>")
                            code.push("    <int>0</int>")
                            code.push("  </Values>")
                            code.push("  <VariableIndexes>")
                            code.push("    <int>"+(variable_number(woords[3]))+"</int>")
                            code.push("    <int>0</int>")
                            code.push("  </VariableIndexes>")
                            code.push("  <Variable>INDEX</Variable>")

                        }
                }else if (woords[1] == "sound") {
                    code.push("  <ConnectIndexBranches>")
                    if (i == lines.length-1){
                        code.push("    <int>1</int>")
                    }else{
                        code.push("    <int>"+(i+3)+"</int>")
                    }
                    code.push("  </ConnectIndexBranches>")
                    code.push("  <Condition>SOUND</Condition>")
                    code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                    code.push("  <Select>BUTTON_ON</Select>")

                    code.push("  <Values>")
                    code.push("    <int>0</int>")
                    code.push("    <int>0</int>")
                    code.push("  </Values>")
                    code.push("  <VariableIndexes>")
                    code.push("    <int>0</int>")
                    code.push("    <int>0</int>")
                    code.push("  </VariableIndexes>")
                    code.push("  <Variable>INVALID</Variable>")


                }else if (woords[1] == "alarm") {
                    code.push("  <ConnectIndexBranches>")
                    if (i == lines.length-1){
                        code.push("    <int>1</int>")
                    }else{
                        code.push("    <int>"+(i+3)+"</int>")
                    }
                    code.push("  </ConnectIndexBranches>")
                    code.push("  <Condition>ALARM</Condition>")
                    code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                    if (woords[2] == "on") {
                        code.push("  <Select>BUTTON_ON</Select>")
                    }else {
                        code.push("  <Select>BUTTON_OFF</Select>")
                    }

                    code.push("  <Values>")
                    code.push("    <int>0</int>")
                    code.push("    <int>0</int>")
                    code.push("  </Values>")
                    code.push("  <VariableIndexes>")
                    code.push("    <int>0</int>")
                    code.push("    <int>0</int>")
                    code.push("  </VariableIndexes>")
                    code.push("  <Variable>INVALID</Variable>")


                }else if (woords[1] == "timer") {
                    code.push("  <ConnectIndexBranches>")
                    if (i == lines.length-1){
                        code.push("    <int>1</int>")
                    }else{
                        code.push("    <int>"+(i+3)+"</int>")
                    }
                    code.push("  </ConnectIndexBranches>")
                    code.push("  <Condition>TIMER</Condition>")
                    code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                    if (woords[2] == "on") {
                        code.push("  <Select>BUTTON_ON</Select>")
                    }else {
                        code.push("  <Select>BUTTON_OFF</Select>")
                    }

                    code.push("  <Values>")
                    code.push("    <int>0</int>")
                    code.push("    <int>0</int>")
                    code.push("  </Values>")
                    code.push("  <VariableIndexes>")
                    code.push("    <int>0</int>")
                    code.push("    <int>0</int>")
                    code.push("  </VariableIndexes>")
                    code.push("  <Variable>INVALID</Variable>")


                }else if (woords[1] == "time") {
                    code.push("  <ConnectIndexBranches>")
                    if (i == lines.length-1){
                        code.push("    <int>1</int>")
                    }else{
                        code.push("    <int>"+(i+3)+"</int>")
                    }
                    code.push("  </ConnectIndexBranches>")
                    code.push("  <Condition>TIME</Condition>")
                    code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                    if (woords[2] == "==") {
                        code.push("  <Select>BUTTON_OFF</Select>")
                    }else if (woords[2] == ">") {
                        code.push("  <Select>BUTTON_ON</Select>")
                    }else if (woords[2] == "<") {
                        code.push("  <Select>COMPARE_GREATER</Select>")
                    }
                    code.push("  <Values>")
                    code.push("    <int>"+(woords[3])+"</int>")
                    code.push("    <int>"+(woords[4])+"</int>")
                    code.push("  </Values>")
                    code.push("  <VariableIndexes>")
                    code.push("    <int>0</int>")
                    code.push("    <int>0</int>")
                    code.push("  </VariableIndexes>")
                    code.push("  <Variable>INVALID</Variable>")


                }else if (woords[1] == "temp") {
                        code.push("  <ConnectIndexBranches>")
                        if (i == lines.length-1){
                            code.push("    <int>1</int>")
                        }else{
                            code.push("    <int>"+(i+3)+"</int>")
                        }
                        code.push("  </ConnectIndexBranches>")
                        code.push("  <Condition>TEMPERATURE</Condition>")
                        code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                        if (woords[2] == "==") {
                            code.push("  <Select>BUTTON_OFF</Select>")
                        }else if (woords[2] == ">") {
                            code.push("  <Select>COMPARE_GREATER</Select>")
                        }else if (woords[2] == "<") {
                            code.push("  <Select>BUTTON_ON</Select>")
                        }

                        code.push("  <Values>")
                        if (!isNaN(Number(woords[3]))) {
                            code.push("    <int>"+(woords[3])+"</int>")
                            code.push("    <int>0</int>")
                            code.push("  </Values>")
                            code.push("  <VariableIndexes>")
                            code.push("    <int>0</int>")
                            code.push("    <int>0</int>")
                            code.push("  </VariableIndexes>")
                            code.push("  <Variable>CONST</Variable>")
                        }else {
                            code.push("    <int>0</int>")
                            code.push("    <int>0</int>")
                            code.push("  </Values>")
                            code.push("  <VariableIndexes>")
                            code.push("    <int>"+(variable_number(woords[3]))+"</int>")
                            code.push("    <int>0</int>")
                            code.push("  </VariableIndexes>")
                            code.push("  <Variable>INDEX</Variable>")

                        }
                }else if (woords[1] == "random") {
                    code.push("  <ConnectIndexBranches>")
                    if (i == lines.length-1){
                        code.push("    <int>1</int>")
                    }else{
                        code.push("    <int>"+(i+3)+"</int>")
                    }
                    code.push("  </ConnectIndexBranches>")
                    code.push("  <Condition>RANDOM</Condition>")
                    code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                    code.push("  <Select>BUTTON_ON</Select>")

                    code.push("  <Values>")
                    code.push("    <int>0</int>")
                    code.push("    <int>0</int>")
                    code.push("  </Values>")
                    code.push("  <VariableIndexes>")
                    code.push("    <int>0</int>")
                    code.push("    <int>0</int>")
                    code.push("  </VariableIndexes>")
                    code.push("  <Variable>CONST</Variable>")


                }else if (woords[1] == "count") {
                        code.push("  <ConnectIndexBranches>")
                        if (i == lines.length-1){
                            code.push("    <int>1</int>")
                        }else{
                            code.push("    <int>"+(i+3)+"</int>")
                        }
                        code.push("  </ConnectIndexBranches>")
                        code.push("  <Condition>COUNTER</Condition>")
                        code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                        if (woords[2] == "==") {
                            code.push("  <Select>BUTTON_OFF</Select>")
                        }else if (woords[2] == ">") {
                            code.push("  <Select>COMPARE_GREATER</Select>")
                        }else if (woords[2] == "<") {
                            code.push("  <Select>BUTTON_ON</Select>")
                        }

                        code.push("  <Values>")
                        code.push("    <int>"+(woords[3])+"</int>")
                        code.push("    <int>0</int>")
                        code.push("  </Values>")
                        code.push("  <VariableIndexes>")
                        code.push("    <int>0</int>")
                        code.push("    <int>0</int>")
                        code.push("  </VariableIndexes>")
                        code.push("  <Variable>CONST</Variable>")

                }else if (["a","b","c","d","e","f","g","h"].includes(woords[1])) {
                        code.push("  <ConnectIndexBranches>")
                        if (i == lines.length-1){
                            code.push("    <int>1</int>")
                        }else{
                            code.push("    <int>"+(i+3)+"</int>")
                        }
                        code.push("  </ConnectIndexBranches>")
                        code.push("  <Condition>VARIABLE</Condition>")
                        code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                        if (woords[2] == "==") {
                            code.push("  <Select>BUTTON_OFF</Select>")
                        }else if (woords[2] == ">") {
                            code.push("  <Select>COMPARE_GREATER</Select>")
                        }else if (woords[2] == "<") {
                            code.push("  <Select>BUTTON_ON</Select>")
                        }

                        code.push("  <Values>")
                        if (!isNaN(Number(woords[3]))) {
                            code.push("    <int>"+(woords[3])+"</int>")
                            code.push("    <int>0</int>")
                            code.push("  </Values>")
                            code.push("  <VariableIndexes>")
                            code.push("    <int>"+(variable_number(woords[1]))+"</int>")
                            code.push("    <int>0</int>")
                            code.push("  </VariableIndexes>")
                            code.push("  <Variable>CONST</Variable>")
                        }else {
                            code.push("    <int>0</int>")
                            code.push("    <int>0</int>")
                            code.push("  </Values>")
                            code.push("  <VariableIndexes>")
                            code.push("    <int>"+(variable_number(woords[1]))+"</int>")
                            code.push("    <int>"+(variable_number(woords[3]))+"</int>")
                            code.push("  </VariableIndexes>")
                            code.push("  <Variable>INDEX</Variable>")

                        }
                }

                code.push("</BlockIf>")
                    
            }else if (woords[0] == "variable") {
                let Assignment = 0
                code.push("<BlockArithmetic>")
                code.push("  <LineCount>1</LineCount>")
                code.push(connectindex(i,l,iflast))
                code.push(connectindexbefore(i,iffast,lines,myindex))

                code.push("  <VariableIndex>")
                if (woords[1] == "a") {
                    code.push("    <int>0</int>")
                }else if (woords[1] == "b") {
                    code.push("    <int>1</int>")
                }else if (woords[1] == "c") {
                    code.push("    <int>2</int>")
                }else if (woords[1] == "d") {
                    code.push("    <int>3</int>")
                }else if (woords[1] == "e") {
                    code.push("    <int>4</int>")
                }else if (woords[1] == "f") {
                    code.push("    <int>5</int>")
                }else if (woords[1] == "g") {
                    code.push("    <int>6</int>")
                }else if (woords[1] == "h") {
                    code.push("    <int>7</int>")
                }
                if (woords[3] == "a") {
                    code.push("    <int>0</int>")
                    Assignment = "INDEX"
                }else if (woords[3] == "b") {
                    code.push("    <int>1</int>")
                    Assignment = "INDEX"
                }else if (woords[3] == "c") {
                    code.push("    <int>2</int>")
                    Assignment = "INDEX"
                }else if (woords[3] == "d") {
                    code.push("    <int>3</int>")
                    Assignment = "INDEX"
                }else if (woords[3] == "e") {
                    code.push("    <int>4</int>")
                    Assignment = "INDEX"
                }else if (woords[3] == "f") {
                    code.push("    <int>5</int>")
                    Assignment = "INDEX"
                }else if (woords[3] == "g") {
                    code.push("    <int>6</int>")
                    Assignment = "INDEX"
                }else if (woords[3] == "h") {
                    code.push("    <int>7</int>")
                    Assignment = "INDEX"
                }else
                    code.push("    <int>0</int>")
                    if (!isNaN(Number(woords[3]))) {
                        Assignment = "CONST"
                    }else if (woords[3] == "temp") {
                        Assignment = "TEMPERATURE"
                    }else if (woords[3] == "light") {
                        Assignment = "LIGHT"
                    }
                
                code.push("  </VariableIndex>")
                if (!isNaN(Number(woords[3]))) {
                    code.push("  <ConstValue>"+(woords[3])+"</ConstValue>")
                }
                code.push("  <Variable>"+(Assignment)+"</Variable>")

                if (woords[2] == "=") {
                    code.push("  <Operate>EQUAL</Operate>")
                }else if (woords[2] == "+=") {
                    code.push("  <Operate>ADD</Operate>")
                }else if (woords[2] == "-=") {
                    code.push("  <Operate>SUB</Operate>")
                }

                code.push("</BlockArithmetic>")

            }else if (woords[0] == "for") {
                code.push("<BlockLoopStart>")
                code.push("  <LineCount>1</LineCount>")
                indexes.push(String(code.length)+","+String(myindex)+","+String(i+2))
                code.push(connectindexbefore(i,iffast,lines,myindex))

                code.push("  <ConnectIndexBranches>")
                if (i == lines.length-1){
                    code.push("    <int>1</int>")
                }else{
                    code.push("    <int>"+(i+3)+"</int>")
                }
                code.push("  </ConnectIndexBranches>")
                if (woords.length > 1) {
                    code.push("  <Count>"+(woords[1])+"</Count>")
                }else {
                    code.push("  <Count>0</Count>")
                }
                code.push("  <BlockLoopEnd>")
                code.push("    <Variable>CONST</Variable>")
                code.push("  </BlockLoopEnd>")
                code.push("</BlockLoopStart>")

            }else if (woords[0] == "while") {
                code.push("<BlockLoopStart>")
                code.push("  <LineCount>1</LineCount>")
                indexes.push(String(code.length)+","+String(myindex)+","+String(i+2))
                code.push(connectindexbefore(i,iffast,lines,myindex))

                code.push("  <ConnectIndexBranches>")
                if (i == lines.length-1){
                    code.push("    <int>1</int>")
                }else{
                    code.push("    <int>"+(i+3)+"</int>")
                }
                code.push("  </ConnectIndexBranches>")
                if (!isNaN(Number(woords[1]))) {
                    code.push("  <Count>"+(woords[1])+"</Count>")
                    woords.splice(1,1)
                }else {
                    code.push("  <Count>0</Count>")
                }
                code.push("  <BlockLoopEnd>")
                code.push("    <IsCondition>true</IsCondition>")



                if (woords.length > 1) {
                    if (woords[1] == "button") {
                        code.push("    <Condition>BUTTON</Condition>")
                        if (woords[2] == "on") {
                            code.push("    <Select>BUTTON_ON</Select>")
                        }else if (woords[2] == "off") {
                            code.push("    <Select>BUTTON_OFF</Select>")
                        }
                    }else if (woords[1] == "light") {
                        code.push("    <Condition>LIGHT</Condition>")
                        code.push("    <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                        if (woords[2] == "==") {
                            code.push("    <Select>COMPARE_GREATER</Select>")
                        }else if (woords[2] == ">") {
                            code.push("    <Select>BUTTON_ON</Select>")
                        }else if (woords[2] == "<") {
                            code.push("    <Select>BUTTON_OFF</Select>")
                        }

                        code.push("    <Values>")
                        if (!isNaN(Number(woords[3]))) {
                            code.push("      <int>"+(woords[3])+"</int>")
                            code.push("      <int>0</int>")
                            code.push("    </Values>")
                            code.push("    <VariableIndexes>")
                            code.push("      <int>0</int>")
                            code.push("      <int>0</int>")
                            code.push("    </VariableIndexes>")
                            code.push("    <Variable>CONST</Variable>")
                        }else {
                            code.push("      <int>0</int>")
                            code.push("      <int>0</int>")
                            code.push("    </Values>")
                            code.push("    <VariableIndexes>")
                            code.push("      <int>"+(variable_number(woords[3]))+"</int>")
                            code.push("      <int>0</int>")
                            code.push("    </VariableIndexes>")
                            code.push("    <Variable>INDEX</Variable>")

                        }
                    }else if (woords[1] == "sound") {
                        code.push("    <Condition>SOUND</Condition>")
                        if (woords[2] == "on") {
                            code.push("    <Select>BUTTON_ON</Select>")
                        }else if (woords[2] == "off") {
                            code.push("    <Select>BUTTON_OFF</Select>")
                        }

                    }else if (woords[1] == "alarm") {
                        code.push("    <Condition>ALARM</Condition>")
                        if (woords[2] == "on") {
                            code.push("    <Select>BUTTON_ON</Select>")
                        }else if (woords[2] == "off") {
                            code.push("    <Select>BUTTON_OFF</Select>")
                        }

                    }else if (woords[1] == "timer") {
                        code.push("    <Condition>TIMER</Condition>")
                        if (woords[2] == "on") {
                            code.push("    <Select>BUTTON_ON</Select>")
                        }else if (woords[2] == "off") {
                            code.push("    <Select>BUTTON_OFF</Select>")
                        }

                    }else if (woords[1] == "time") {
                        code.push("  <Condition>TIME</Condition>")
                        code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                        if (woords[2] == "==") {
                            code.push("  <Select>BUTTON_OFF</Select>")
                        }else if (woords[2] == ">") {
                            code.push("  <Select>BUTTON_ON</Select>")
                        }else if (woords[2] == "<") {
                            code.push("  <Select>COMPARE_GREATER</Select>")
                        }
                        code.push("  <Values>")
                        code.push("    <int>"+(woords[3])+"</int>")
                        code.push("    <int>"+(woords[4])+"</int>")
                        code.push("  </Values>")
                        code.push("  <VariableIndexes>")
                        code.push("    <int>0</int>")
                        code.push("    <int>0</int>")
                        code.push("  </VariableIndexes>")
                        code.push("  <Variable>INVALID</Variable>")


                    }else if (woords[1] == "temp") {
                        code.push("  <Condition>TEMPERATURE</Condition>")
                        code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                        if (woords[2] == "==") {
                            code.push("  <Select>BUTTON_OFF</Select>")
                        }else if (woords[2] == ">") {
                            code.push("  <Select>COMPARE_GREATER</Select>")
                        }else if (woords[2] == "<") {
                            code.push("  <Select>BUTTON_ON</Select>")
                        }

                        code.push("  <Values>")
                        if (!isNaN(Number(woords[3]))) {
                            code.push("    <int>"+(woords[3])+"</int>")
                            code.push("    <int>0</int>")
                            code.push("  </Values>")
                            code.push("  <VariableIndexes>")
                            code.push("    <int>0</int>")
                            code.push("    <int>0</int>")
                            code.push("  </VariableIndexes>")
                            code.push("  <Variable>CONST</Variable>")
                        }else {
                            code.push("    <int>0</int>")
                            code.push("    <int>0</int>")
                            code.push("  </Values>")
                            code.push("  <VariableIndexes>")
                            code.push("    <int>"+(variable_number(woords[3]))+"</int>")
                            code.push("    <int>0</int>")
                            code.push("  </VariableIndexes>")
                            code.push("  <Variable>INDEX</Variable>")

                        }
                    }else if (woords[1] == "count") {
                        code.push("  <Condition>COUNTER</Condition>")
                        code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                        if (woords[2] == "==") {
                            code.push("  <Select>BUTTON_OFF</Select>")
                        }else if (woords[2] == ">") {
                            code.push("  <Select>COMPARE_GREATER</Select>")
                        }else if (woords[2] == "<") {
                            code.push("  <Select>BUTTON_ON</Select>")
                        }

                        code.push("  <Values>")
                        code.push("    <int>"+(woords[3])+"</int>")
                        code.push("    <int>0</int>")
                        code.push("  </Values>")
                        code.push("  <VariableIndexes>")
                        code.push("    <int>0</int>")
                        code.push("    <int>0</int>")
                        code.push("  </VariableIndexes>")
                        code.push("  <Variable>CONST</Variable>")

                    }else if (["a","b","c","d","e","f","g","h"].includes(woords[1])) {
                        code.push("  <Condition>VARIABLE</Condition>")
                        code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                        if (woords[2] == "==") {
                            code.push("  <Select>BUTTON_OFF</Select>")
                        }else if (woords[2] == ">") {
                            code.push("  <Select>COMPARE_GREATER</Select>")
                        }else if (woords[2] == "<") {
                            code.push("  <Select>BUTTON_ON</Select>")
                        }

                        code.push("  <Values>")
                        if (!isNaN(Number(woords[3]))) {
                            code.push("    <int>"+(woords[3])+"</int>")
                            code.push("    <int>0</int>")
                            code.push("  </Values>")
                            code.push("  <VariableIndexes>")
                            code.push("    <int>"+(variable_number(woords[1]))+"</int>")
                            code.push("    <int>0</int>")
                            code.push("  </VariableIndexes>")
                            code.push("  <Variable>CONST</Variable>")
                        }else {
                            code.push("    <int>0</int>")
                            code.push("    <int>0</int>")
                            code.push("  </Values>")
                            code.push("  <VariableIndexes>")
                            code.push("    <int>"+(variable_number(woords[1]))+"</int>")
                            code.push("    <int>"+(variable_number(woords[3]))+"</int>")
                            code.push("  </VariableIndexes>")
                            code.push("  <Variable>INDEX</Variable>")

                        }
                    }



                }



            
                code.push("    <Variable>CONST</Variable>")
                code.push("  </BlockLoopEnd>")
                code.push("</BlockLoopStart>")

            }else if (woords[0] == "disp") {
                code.push("<BlockDisplay>");
                code.push("  <LineCount>1</LineCount>")
                code.push(connectindex(i,l,iflast));
                code.push(connectindexbefore(i,iffast,lines,myindex))
                if (woords[1] == "time") {
                    code.push("  <Mode>TIME</Mode>")
                }else if (woords[1] == "temp") {
                    code.push("  <Mode>TEMPERATURE</Mode>")
                }else if (woords[1] == "count") {
                    code.push("  <Mode>COUNTER</Mode>")
                }else if (woords[1] == "light") {
                    code.push("  <Mode>LIGHT</Mode>")
                }else if (woords[1] == "wait") {
                    code.push("  <Mode>WAIT</Mode>")
                }else if  (["a","b","c","d","e","f","g","h"].includes(woords[1])) {
                    code.push("  <Mode>VARIABLE</Mode>")
                    code.push("  <VariableIndex>"+(variable_number(woords[1]))+"</VariableIndex>")
                }
                    



                code.push("</BlockDisplay>");

            }else if (woords[0] == "sub") {
                code.push("<BlockSubroutine>")
                code.push("  <LineCount>1</LineCount>")
                code.push(connectindex(i,l,iflast));
                code.push(connectindexbefore(i,iffast,lines,myindex))

                code.push("  <Index>"+(woords[1]-1)+"</Index>")

                code.push("</BlockSubroutine>")
            }
            
        }

            
    }
    const indexcode = code.map(line => "        " + line);

    indexcode.splice(0,0,'<?xml version="1.0" encoding="utf-16"?>','<ProgramModules xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">','  <Version>1</Version>','  <Programs>','    <ProgramModule>','      <Name>メイン</Name>','      <Blocks>')












    downloadFile(indexcode.join("\n"), `output.${ext}`);
}


// ダウンロード関数
function downloadFile(text, filename) {
    const blob = new Blob([text], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
}

</script>
</body>
</html>
