<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>テキストベースでコロックルをプログラム -コロボックル-</title>
<style>
textarea { width: 80%; height: 700px; }
</style>
</head>
<body>

    <h2>コロボックル</h2>
    <textarea id="input" rows="20" cols="60"></textarea>

    <button id="saveBlp" tabindex="-1">ブロック形式blpで保存</button>
    <button id="saveFcp" tabindex="-1">フローチャート形式fcpで保存</button>

<script>
const editor = document.getElementById("input");

editor.addEventListener("keydown", function(e) {
    if (e.key === "Tab") {
        e.stopPropagation();  // 他の処理へ渡さない（重要）
        e.preventDefault();

        const indent = "    ";
        const start = editor.selectionStart;
        const end = editor.selectionEnd;

        editor.setRangeText(indent, start, end, "end");
    }
});


document.getElementById("saveBlp").addEventListener("click", () => {
    saveFile("blp");
});

document.getElementById("saveFcp").addEventListener("click", () => {
    saveFile("fcp");
});

function connectindex(i,lines,iflast){
    if (iflast==0) {
        if (i == lines.length-1){
            return ("  <ConnectIndex>1</ConnectIndex>")
        }else{
            return ("  <ConnectIndex>"+(i+3)+"</ConnectIndex>")
        }
        }else {
            return ("  <ConnectIndex>-1</ConnectIndex>")
        }
}
function connectindexbefore(i,iffast) {
    if (iffast==0) {
        if (i == 0){
            return("  <ConnectIndexBefore>"+(i)+"</ConnectIndexBefore>")
        }else{
            return("  <ConnectIndexBefore>"+(i+1)+"</ConnectIndexBefore>")
        }    
    }else {
        return("  <ConnectIndexBefore>-1</ConnectIndexBefore>")
    }
}


function saveFile(ext) {
    const textarea = document.getElementById("input");
    const text = textarea.value;

    const lines = text.split("\n");
    let code = [];

    code.push("<BlockStart>")
    code.push("  <LineCount>1</LineCount>")
    code.push("  <ConnectIndex>2</ConnectIndex>")
    code.push("  <ConnectIndexBefore>-1</ConnectIndexBefore>")
    code.push("</BlockStart>")
    code.push("<BlockEnd>")
    code.push("  <LineCount>1</LineCount>")
    code.push("  <ConnectIndex>-1</ConnectIndex>")
    code.push("  <ConnectIndexBefore>"+(lines.length+1)+"</ConnectIndexBefore>")
    code.push("</BlockEnd>")
    
    const indexes = []

    for (let i = 0; i < lines.length; i++) {
        const woords = lines[i].split(/[, ]/).filter(s => s);
        let iffast = 0;
        let iflast = 0;


        const myindex = (lines[i].match(/^\s*/)[0].length)/4
        let beforeindex = null;
        if (indexes.length > 0) {
            beforeindex = Number(indexes[indexes.length-1].split(",")[1])
            if (beforeindex == myindex) {
                if (woords[0] == "else"){
                    code.splice(Number(indexes[indexes.length-1].split(",")[0]), 0, "  <ConnectIndexElse>"+(i+3)+"</ConnectIndexElse>")
                }else{
                    code.splice(Number(indexes[indexes.length-1].split(",")[0]), 0, "  <ConnectIndex>"+(i+2)+"</ConnectIndex>")
                
                }
            }else {
                if (Number(indexes[indexes.length-1].split(",")[0]) == code.length -7) {
                    iffast = 1
                }
                if ((lines[i+1].match(/^\s*/)[0].length)/4 < myindex) {
                    iflast=1
                }
                
            }
            

        }


        
        if (woords[0] == "led") {
            code.push("<BlockLED>");
            code.push("  <LineCount>1</LineCount>")
            code.push(connectindex(i,lines,iflast));
            code.push(connectindexbefore(i,iffast))
            
            if (woords[1] == "on") {
                code.push("  <Mode>ON</Mode>");
                code.push("  <Red>"+(woords[2])+"</Red>");
                code.push("  <Green>"+(woords[3])+"</Green>");
                code.push("  <Blue>"+(woords[4])+"</Blue>");
            }else if (woords[1] == "time"){
                code.push("  <Mode>ON_TIME</Mode>");
                code.push("  <Red>"+(woords[2])+"</Red>");
                code.push("  <Green>"+(woords[3])+"</Green>");
                code.push("  <Blue>"+(woords[4])+"</Blue>");
                code.push("  <Time>"+(woords[5])+"</Time>");
            }else if (woords[1] == "off"){
                code.push("  <Mode>OFF</Mode>");
            }else if (woords[1] == "in"){
                code.push("  <Mode>ON_TIME</Mode>");
                code.push("  <Red>"+(woords[2])+"</Red>");
                code.push("  <Green>"+(woords[3])+"</Green>");
                code.push("  <Blue>"+(woords[4])+"</Blue>");
                code.push("  <Time>"+(woords[5])+"</Time>");
                code.push("  <Fade>IN</Fade>");
            }else if (woords[1] == "out"){
                code.push("  <Mode>ON_TIME</Mode>");
                code.push("  <Red>"+(woords[2])+"</Red>");
                code.push("  <Green>"+(woords[3])+"</Green>");
                code.push("  <Blue>"+(woords[4])+"</Blue>");
                code.push("  <Time>"+(woords[5])+"</Time>");
                code.push("  <Fade>OUT</Fade>");
            }
            code.push("</BlockLED>");

        } else if (woords[0] == "beep") {
            code.push("<BlockSound>");
            code.push("  <LineCount>1</LineCount>")
            code.push(connectindex(i,lines,iflast));
            code.push(connectindexbefore(i,iffast))
            if (woords[1] == "play") {
                if (woords[1] == "true") {
                    code.push("  <Loop>true</Loop>");
                }else {
                    code.push("  <Loop>false</Loop>");
                }
                code.push("  <Mode>MELODY_PLAY</Mode>");
            }else if (woords[1] == "stop") {
                code.push("  <Mode>MELODY_STOP</Mode>");
            }else {
                code.push("  <Mode>BEEP</Mode>");
                code.push("  <BeepIndex>"+(woords[1]-1)+"</BeepIndex>");
            }
            code.push("</BlockSound>");

        } else if (woords[0] == "wait") {
            code.push("<BlockWait>")
            code.push("  <LineCount>1</LineCount>")
            code.push(connectindex(i,lines,iflast));
            code.push(connectindexbefore(i,iffast))
            code.push("  <Time>"+(woords[1])+"</Time>")
            code.push("</BlockWait>");

        } else if (woords[0] == "count") {
            code.push("<BlockCounter>")
            code.push("  <LineCount>1</LineCount>")
            code.push(connectindex(i,lines,iflast));
            code.push(connectindexbefore(i,iffast))
            if (woords[1] == "start") {
                code.push("  <Command>START</Command>")
            }else if (woords[1] == "stop") {
                code.push("  <Command>STOP</Command>")
            }else if (woords[1] == "reset") {
                code.push("  <Command>RESET</Command>")
            }
            code.push("</BlockCounter>");
        }else if (woords[0] == "if") {
            code.push("<BlockIf>")
            code.push("  <LineCount>1</LineCount>")
            indexes.push(String(code.length)+","+String(myindex))
            code.push(connectindexbefore(i,iffast))
            if (woords[1] == "botton") {
                code.push("  <ConnectIndexBranches>")
                if (i == lines.length-1){
                    code.push("    <int>1</int>")
                }else{
                    code.push("    <int>"+(i+3)+"</int>")
                }
                code.push("  </ConnectIndexBranches>")
                code.push("  <Condition>BUTTON</Condition>")
                code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                code.push("  <Select>BUTTON_ON</Select>")


            }else{
                if (woords[1] == "light") {
                    code.push("  <ConnectIndexBranches>")
                    if (i == lines.length-1){
                        code.push("    <int>1</int>")
                    }else{
                        code.push("    <int>"+(i+3)+"</int>")
                    }
                    code.push("  </ConnectIndexBranches>")
                    code.push("  <Condition>BUTTON</Condition>")
                    code.push("  <ConditionNetwork>OBJECT_BUTTON</ConditionNetwork>")
                    code.push("  <Select>BUTTON_ON</Select>")


                }

            }

            code.push("</BlockIf>")
                
        }else if (woords[0] == "variable") {
            let Assignment = 0
            code.push("<BlockArithmetic>")
            code.push("  <LineCount>1</LineCount>")
            code.push(connectindex(i,lines,iflast))
            code.push(connectindexbefore(i,iffast))

            code.push("  <VariableIndex>")
            if (woords[1] == "a") {
                code.push("    <int>0</int>")
            }else if (woords[1] == "b") {
                code.push("    <int>1</int>")
            }else if (woords[1] == "c") {
                code.push("    <int>2</int>")
            }else if (woords[1] == "d") {
                code.push("    <int>3</int>")
            }else if (woords[1] == "e") {
                code.push("    <int>4</int>")
            }else if (woords[1] == "f") {
                code.push("    <int>5</int>")
            }else if (woords[1] == "g") {
                code.push("    <int>6</int>")
            }else if (woords[1] == "h") {
                code.push("    <int>7</int>")
            }
            if (woords[3] == "a") {
                code.push("    <int>0</int>")
                Assignment = "INDEX"
            }else if (woords[3] == "b") {
                code.push("    <int>1</int>")
                Assignment = "INDEX"
            }else if (woords[3] == "c") {
                code.push("    <int>2</int>")
                Assignment = "INDEX"
            }else if (woords[3] == "d") {
                code.push("    <int>3</int>")
                Assignment = "INDEX"
            }else if (woords[3] == "e") {
                code.push("    <int>4</int>")
                Assignment = "INDEX"
            }else if (woords[3] == "f") {
                code.push("    <int>5</int>")
                Assignment = "INDEX"
            }else if (woords[3] == "g") {
                code.push("    <int>6</int>")
                Assignment = "INDEX"
            }else if (woords[3] == "h") {
                code.push("    <int>7</int>")
                Assignment = "INDEX"
            }else
                code.push("    <int>0</int>")
                if (!isNaN(Number(woords[3]))) {
                    Assignment = "CONST"
                }else if (woords[3] == "temp") {
                    Assignment = "TEMPERATURE"
                }else if (woords[3] == "light") {
                    Assignment = "LIGHT"
                }
            
            code.push("  </VariableIndex>")
            if (!isNaN(Number(woords[3]))) {
                code.push("  <ConstValue>"+(woords[3])+"</ConstValue>")
            }
            code.push("  <Variable>"+(Assignment)+"</Variable>")

            if (woords[2] == "=") {
                code.push("  <Operate>EQUAL</Operate>")
            }else if (woords[2] == "+=") {
                code.push("  <Operate>ADD</Operate>")
            }else if (woords[2] == "-=") {
                code.push("  <Operate>SUB</Operate>")
            }

            code.push("</BlockArithmetic>")

        }
        
        

        
    }

    downloadFile(code.join("\n"), `output.${ext}`);
}


// ダウンロード関数
function downloadFile(text, filename) {
    const blob = new Blob([text], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
}

</script>
</body>
</html>
